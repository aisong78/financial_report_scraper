# äº§å“æ¶æ„æ–‡æ¡£

> ğŸ“ è´¢æŠ¥æ™ºèƒ½åˆ†æç³»ç»Ÿ - ä¸‰å±‚æ¶æ„è®¾è®¡è¯´æ˜

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)
3. [å±‚æ¬¡è¯¦è§£](#å±‚æ¬¡è¯¦è§£)
4. [æ•°æ®æµå‘](#æ•°æ®æµå‘)
5. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
6. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

æœ¬ç³»ç»Ÿé‡‡ç”¨ç»å…¸çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼Œä»ä¸‹åˆ°ä¸Šåˆ†åˆ«æ˜¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           3. è¡¨ç¤ºå±‚ (Presentation)           â”‚
â”‚  - stock_analyzer.py (CLIåˆ†æå·¥å…·)          â”‚
â”‚  - ç”¨æˆ·äº¤äº’å’Œç»“æœå±•ç¤º                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           2. ä¸šåŠ¡é€»è¾‘å±‚ (Business)            â”‚
â”‚  - åˆ†ææ¡†æ¶å¼•æ“ (FrameworkEngine)            â”‚
â”‚  - ä»·å€¼æŠ•èµ„æ¡†æ¶ (ValueInvestingFramework)    â”‚
â”‚  - æˆé•¿æŠ•èµ„æ¡†æ¶ (GrowthInvestingFramework)   â”‚
â”‚  - è¯„åˆ†å’Œå»ºè®®ç”Ÿæˆ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           1. æ•°æ®å±‚ (Data Access)            â”‚
â”‚  - DataCollector (æ•°æ®é‡‡é›†æœåŠ¡)              â”‚
â”‚  - Scraper (è´¢æŠ¥ä¸‹è½½)                        â”‚
â”‚  - Parser (è´¢æŠ¥è§£æ)                         â”‚
â”‚  - Database (æ•°æ®å­˜å‚¨)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹ç‚¹

- âœ… **å±‚æ¬¡æ¸…æ™°**ï¼šèŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤
- âœ… **ä½è€¦åˆ**ï¼šå±‚é—´ä¾èµ–æœ€å°åŒ–
- âœ… **é«˜å†…èš**ï¼šæ¯å±‚åŠŸèƒ½å†…èš
- âœ… **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **å¯æµ‹è¯•**ï¼šæ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•

---

## ğŸ’¡ è®¾è®¡ç†å¿µ

### 1. æ¸è¿›å¼å¢å¼º

ç³»ç»ŸæŒ‰é˜¶æ®µé€æ­¥æ„å»ºï¼Œæ¯ä¸ªPhaseæ„å»ºä¸€å±‚ï¼š

```
Phase 0 + Phase 1 â†’ æ•°æ®å±‚
Phase 2 â†’ ä¸šåŠ¡é€»è¾‘å±‚
Phase 3 â†’ è¡¨ç¤ºå±‚å¢å¼º
Phase 4+ â†’ æ‰©å±•åŠŸèƒ½
```

**ä¼˜ç‚¹**ï¼š
- æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥ç‹¬ç«‹äº¤ä»˜
- é£é™©å¯æ§ï¼Œæ˜“äºæµ‹è¯•
- ç”¨æˆ·å¯ä»¥é€æ­¥ä½“éªŒæ–°åŠŸèƒ½

### 2. æ•°æ®é©±åŠ¨

```
æ•°æ®é‡‡é›† â†’ æ•°æ®å­˜å‚¨ â†’ æ•°æ®åˆ†æ â†’ ç»“æœå±•ç¤º
```

æ‰€æœ‰åŠŸèƒ½éƒ½å»ºç«‹åœ¨é«˜è´¨é‡çš„è´¢åŠ¡æ•°æ®åŸºç¡€ä¸Šã€‚

### 3. ç”¨æˆ·ä¸ºä¸­å¿ƒ

```
ç”¨æˆ·éœ€æ±‚ â†’ åŠŸèƒ½è®¾è®¡ â†’ å®ç° â†’ æµ‹è¯• â†’ åé¦ˆ
```

æ¯ä¸ªåŠŸèƒ½éƒ½è€ƒè™‘ç”¨æˆ·ä½“éªŒï¼š
- è‡ªåŠ¨æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
- äº¤äº’å¼ç¡®è®¤
- æ¸…æ™°çš„æç¤ºä¿¡æ¯
- çµæ´»çš„æ§åˆ¶é€‰é¡¹

### 4. é™çº§ç­–ç•¥

```
çœŸå®æ•°æ® â†’ Mockæ•°æ® â†’ æç¤ºé”™è¯¯
```

å³ä½¿åœ¨ç†æƒ³æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œç³»ç»Ÿä»èƒ½æä¾›åŸºæœ¬åŠŸèƒ½ã€‚

---

## ğŸ“š å±‚æ¬¡è¯¦è§£

### Layer 1: æ•°æ®å±‚ (Data Access Layer)

**èŒè´£**ï¼šé‡‡é›†ã€è§£æã€å­˜å‚¨è´¢åŠ¡æ•°æ®

#### æ ¸å¿ƒç»„ä»¶

```python
src/
â”œâ”€â”€ scrapers/              # è´¢æŠ¥ä¸‹è½½
â”‚   â”œâ”€â”€ base_scraper.py    # çˆ¬è™«åŸºç±»
â”‚   â”œâ”€â”€ cn_scraper.py      # Aè‚¡/æ¸¯è‚¡çˆ¬è™«
â”‚   â””â”€â”€ us_scraper.py      # ç¾è‚¡çˆ¬è™«
â”‚
â”œâ”€â”€ parsers/               # è´¢æŠ¥è§£æ
â”‚   â”œâ”€â”€ base_parser.py     # è§£æå™¨åŸºç±»
â”‚   â”œâ”€â”€ pdf_parser.py      # PDFè§£æå™¨
â”‚   â””â”€â”€ html_parser.py     # HTMLè§£æå™¨
â”‚
â”œâ”€â”€ services/              # æ•°æ®æœåŠ¡
â”‚   â”œâ”€â”€ data_collector.py  # æ•°æ®é‡‡é›†æœåŠ¡ âœ¨
â”‚   â””â”€â”€ mock_data_source.py # Mockæ•°æ®æº
â”‚
â”œâ”€â”€ database/              # æ•°æ®å­˜å‚¨
â”‚   â””â”€â”€ models.py          # æ•°æ®æ¨¡å‹ï¼ˆORMï¼‰
â”‚
â””â”€â”€ extractors/            # æŒ‡æ ‡æå–
    â””â”€â”€ metric_extractor.py # è´¢åŠ¡æŒ‡æ ‡æå–å™¨
```

#### å…³é”®æ¥å£

**DataCollector**ï¼ˆæ ¸å¿ƒæœåŠ¡ç±»ï¼‰ï¼š

```python
class DataCollector:
    def collect_stock_data(
        stock_code: str,
        years: int = 5,
        report_types: List[str] = ['annual'],
        incremental: bool = False
    ) -> bool:
        """é‡‡é›†è‚¡ç¥¨è´¢åŠ¡æ•°æ®"""

    def check_data_completeness(
        stock_code: str,
        years: int = 5,
        report_types: List[str] = ['annual']
    ) -> CompletenessReport:
        """æ£€æŸ¥æ•°æ®å®Œæ•´æ€§"""

    def display_completeness_report(
        report: CompletenessReport
    ) -> None:
        """æ˜¾ç¤ºå®Œæ•´æ€§æŠ¥å‘Š"""
```

#### æ•°æ®æµç¨‹

```
1. ç”¨æˆ·è¯·æ±‚æ•°æ®
    â†“
2. DataCollectoræ£€æŸ¥æ•°æ®åº“
    â”œâ”€ æ•°æ®å®Œæ•´ â†’ è¿”å›
    â””â”€ æ•°æ®ç¼ºå¤± â†’ ç»§ç»­
    â†“
3. æ£€æµ‹å¸‚åœºç±»å‹ï¼ˆAè‚¡/æ¸¯è‚¡/ç¾è‚¡ï¼‰
    â†“
4. é€‰æ‹©å¯¹åº”Scraper
    â†“
5. ä¸‹è½½PDFæ–‡ä»¶
    â†“
6. Parserè§£æPDF
    â”œâ”€ æå–ä¸‰å¤§æŠ¥è¡¨æ•°æ®
    â”œâ”€ è®¡ç®—è´¢åŠ¡æ¯”ç‡
    â””â”€ ç”Ÿæˆç½®ä¿¡åº¦è¯„åˆ†
    â†“
7. ä¿å­˜åˆ°æ•°æ®åº“
    â”œâ”€ Stockè¡¨
    â”œâ”€ FinancialReportè¡¨
    â””â”€ FinancialMetricè¡¨
```

#### é™çº§ç­–ç•¥

```python
if not SCRAPERS_AVAILABLE:
    # ä¾èµ–ç¼ºå¤± â†’ Mockæ•°æ®
    return save_mock_data()

try:
    pdf_path = scraper.download_report()
    if not pdf_path:
        # ä¸‹è½½å¤±è´¥ â†’ Mockæ•°æ®
        return save_mock_data()

    parsed_data = parser.parse(pdf_path)
    if parsed_data['confidence'] < 0.3:
        # è§£æç½®ä¿¡åº¦ä½ â†’ Mockæ•°æ®
        return save_mock_data()

    # ä¿å­˜çœŸå®æ•°æ®
    return save_parsed_data(parsed_data)
except Exception as e:
    # ä»»ä½•å¼‚å¸¸ â†’ Mockæ•°æ®
    return save_mock_data()
```

---

### Layer 2: ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)

**èŒè´£**ï¼šå®ç°æŠ•èµ„åˆ†æé€»è¾‘ï¼Œç”Ÿæˆè¯„åˆ†å’Œå»ºè®®

#### æ ¸å¿ƒç»„ä»¶

```python
src/analysis/
â”œâ”€â”€ framework_engine.py        # åˆ†ææ¡†æ¶å¼•æ“ âœ¨
â”œâ”€â”€ value_investing.py         # ä»·å€¼æŠ•èµ„æ¡†æ¶ âœ¨
â”œâ”€â”€ growth_investing.py        # æˆé•¿æŠ•èµ„æ¡†æ¶ âœ¨
â””â”€â”€ base_framework.py          # æ¡†æ¶åŸºç±»
```

#### å…³é”®æ¥å£

**FrameworkEngine**ï¼ˆå¼•æ“ï¼‰ï¼š

```python
class FrameworkEngine:
    def get_framework(name: str) -> BaseFramework:
        """è·å–æŒ‡å®šåˆ†ææ¡†æ¶"""

    def list_frameworks() -> List[Dict]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¡†æ¶"""
```

**BaseFramework**ï¼ˆåŸºç±»ï¼‰ï¼š

```python
class BaseFramework:
    def analyze(stock_code: str) -> Dict:
        """åˆ†æè‚¡ç¥¨ï¼Œè¿”å›ç»“æœ"""

    def calculate_dimension_score(
        dimension_name: str,
        metrics: Dict
    ) -> float:
        """è®¡ç®—æŸä¸ªç»´åº¦çš„å¾—åˆ†"""

    def rate_score(score: float) -> str:
        """æ ¹æ®åˆ†æ•°è¿”å›è¯„çº§"""
```

#### åˆ†ææµç¨‹

```
1. æ¥æ”¶è‚¡ç¥¨ä»£ç 
    â†“
2. ä»æ•°æ®åº“æŸ¥è¯¢è´¢åŠ¡æ•°æ®
    â†“
3. æ ¹æ®æ¡†æ¶å®šä¹‰è®¡ç®—å„ç»´åº¦å¾—åˆ†
    â”œâ”€ ç›ˆåˆ©èƒ½åŠ›
    â”œâ”€ æˆé•¿æ€§
    â”œâ”€ è´¢åŠ¡å¥åº·
    â””â”€ ä¼°å€¼æ°´å¹³
    â†“
4. åŠ æƒè®¡ç®—æ€»åˆ†
    â†“
5. ç”Ÿæˆè¯„çº§ï¼ˆä¼˜ç§€/è‰¯å¥½/ä¸­ç­‰/ä¸åŠæ ¼ï¼‰
    â†“
6. è¿”å›åˆ†æç»“æœ
```

#### æ¡†æ¶ç¤ºä¾‹

**ä»·å€¼æŠ•èµ„æ¡†æ¶**ï¼š

```yaml
framework:
  name: ä»·å€¼æŠ•èµ„æ¡†æ¶
  description: å·´è²ç‰¹é£æ ¼ï¼Œå…³æ³¨ROEã€æ¯›åˆ©ç‡ã€æŠ¤åŸæ²³

  dimensions:
    - name: ç›ˆåˆ©èƒ½åŠ›
      weight: 35%
      indicators:
        - roe: â‰¥15% ä¸ºä¼˜ç§€
        - gross_margin: â‰¥40% ä¸ºä¼˜ç§€
        - net_margin: â‰¥20% ä¸ºä¼˜ç§€

    - name: æˆé•¿æ€§
      weight: 20%
      indicators:
        - revenue_growth: â‰¥15% ä¸ºä¼˜ç§€
        - profit_growth: â‰¥15% ä¸ºä¼˜ç§€

    - name: è´¢åŠ¡å¥åº·
      weight: 30%
      indicators:
        - asset_liability_ratio: â‰¤50% ä¸ºä¼˜ç§€
        - current_ratio: â‰¥2.0 ä¸ºä¼˜ç§€

    - name: ä¼°å€¼æ°´å¹³
      weight: 15%
      indicators:
        - pe_ratio: 10-20 ä¸ºåˆç†
        - pb_ratio: <3 ä¸ºåˆç†
```

**æˆé•¿æŠ•èµ„æ¡†æ¶**ï¼š

```yaml
framework:
  name: æˆé•¿æŠ•èµ„æ¡†æ¶
  description: å½¼å¾—Â·æ—å¥‡é£æ ¼ï¼Œå…³æ³¨å¢é•¿ç‡ã€å¸‚åœºç©ºé—´

  dimensions:
    - name: æˆé•¿æ€§
      weight: 40%  # æœ€é«˜æƒé‡
      indicators:
        - revenue_growth: â‰¥25% ä¸ºä¼˜ç§€
        - profit_growth: â‰¥30% ä¸ºä¼˜ç§€

    - name: ç›ˆåˆ©èƒ½åŠ›
      weight: 25%
      indicators:
        - net_margin: â‰¥15% ä¸ºä¼˜ç§€
        - roe: â‰¥20% ä¸ºä¼˜ç§€

    # ...
```

---

### Layer 3: è¡¨ç¤ºå±‚ (Presentation Layer)

**èŒè´£**ï¼šç”¨æˆ·äº¤äº’ã€ç»“æœå±•ç¤º

#### æ ¸å¿ƒç»„ä»¶

```python
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ stock_analyzer.py          # CLIåˆ†æå·¥å…· âœ¨
â”œâ”€â”€ collect_data.py            # CLIæ•°æ®é‡‡é›†å·¥å…· âœ¨
â””â”€â”€ (æœªæ¥) web_app.py          # Webç•Œé¢
```

#### å…³é”®åŠŸèƒ½

**stock_analyzer.py** - åˆ†æå·¥å…·ï¼š

```bash
Commands:
  analyze     # åˆ†æè‚¡ç¥¨
  screen      # ç­›é€‰è‚¡ç¥¨
  info        # æŸ¥çœ‹è‚¡ç¥¨ä¿¡æ¯
  list        # åˆ—å‡ºæ‰€æœ‰è‚¡ç¥¨
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š

1. **è‡ªåŠ¨æ•°æ®é‡‡é›†**
```python
def ensure_data_available(stock_code, skip_fetch=False):
    """åˆ†æå‰è‡ªåŠ¨æ£€æŸ¥æ•°æ®ï¼Œç¼ºå¤±æ—¶è¯¢é—®ç”¨æˆ·"""
    if skip_fetch:
        return True

    report = collector.check_data_completeness(stock_code)

    if report.is_complete:
        return True  # é™é»˜é€šè¿‡

    # æ˜¾ç¤ºæŠ¥å‘Š + è¯¢é—®ç”¨æˆ·
    collector.display_completeness_report(report)
    confirmed = collector.ask_user_to_collect(stock_code, report)

    if confirmed == 'yes':
        collector.collect_stock_data(stock_code)

    return True  # éé˜»å¡
```

2. **çµæ´»æ§åˆ¶**
```bash
# æ­£å¸¸æ¨¡å¼ï¼šè‡ªåŠ¨æ£€æŸ¥+é‡‡é›†
python stock_analyzer.py analyze 600519

# å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡æ£€æŸ¥
python stock_analyzer.py analyze 600519 --skip-fetch
```

3. **æ‰¹é‡å¯¹æ¯”**
```bash
python stock_analyzer.py analyze 600519 688005 000858

# è¾“å‡ºå¯¹æ¯”è¡¨æ ¼
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â•®
â”‚ è‚¡ç¥¨              â”‚ æ€»åˆ† â”‚ è¯„çº§ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ è´µå·èŒ…å° (600519) â”‚ 70.0 â”‚ ä¸­ç­‰ â”‚
â”‚ å®¹ç™¾ç§‘æŠ€ (688005) â”‚ 48.0 â”‚ ä¸åŠæ ¼â”‚
â”‚ äº”ç²®æ¶² (000858)   â”‚ 68.0 â”‚ ä¸­ç­‰ â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â•¯
```

---

## ğŸ”„ æ•°æ®æµå‘

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥   â”‚
â”‚ 600519      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¨ç¤ºå±‚ (stock_analyzer.py)       â”‚
â”‚ - è§£æå‘½ä»¤è¡Œå‚æ•°                  â”‚
â”‚ - ensure_data_available()        â”‚
â”‚   â”œâ”€ skip_fetch? â†’ è·³è¿‡æ£€æŸ¥       â”‚
â”‚   â”œâ”€ æ•°æ®å®Œæ•´? â†’ ç»§ç»­             â”‚
â”‚   â””â”€ æ•°æ®ç¼ºå¤±? â†’ è¯¢é—®ç”¨æˆ·         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â”‚ (åˆ†æ)          â”‚ (é‡‡é›†)
       â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡é€»è¾‘å±‚    â”‚  â”‚ æ•°æ®å±‚        â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ 1. æŸ¥è¯¢æ•°æ®  â”‚  â”‚ 1. æ£€æµ‹å¸‚åœº  â”‚
â”‚ 2. åº”ç”¨æ¡†æ¶  â”‚  â”‚ 2. ä¸‹è½½PDF   â”‚
â”‚ 3. è®¡ç®—å¾—åˆ†  â”‚  â”‚ 3. è§£ææ•°æ®  â”‚
â”‚ 4. ç”Ÿæˆè¯„çº§  â”‚  â”‚ 4. å­˜å…¥æ•°æ®åº“â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â”‚                 â†“
       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚          â”‚ æ•°æ®åº“       â”‚
       â”‚          â”‚ - Stock     â”‚
       â”‚          â”‚ - Report    â”‚
       â”‚          â”‚ - Metric    â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â†‘
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ ç»“æœå±•ç¤º     â”‚
       â”‚ - è¯„åˆ†       â”‚
       â”‚ - è¯„çº§       â”‚
       â”‚ - è¯¦ç»†åˆ†æ   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”¨æˆ·åœºæ™¯æµç¨‹

**åœºæ™¯1ï¼šæ•°æ®å®Œæ•´ï¼Œç›´æ¥åˆ†æ**

```
ç”¨æˆ·: python stock_analyzer.py analyze 600519
  â†“
è¡¨ç¤ºå±‚: ensure_data_available(600519)
  â”œâ”€ æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
  â””â”€ æ•°æ®å®Œæ•´ â†’ è¿”å› True
  â†“
ä¸šåŠ¡å±‚: framework.analyze(600519)
  â”œâ”€ æŸ¥è¯¢æ•°æ®åº“
  â”œâ”€ è®¡ç®—å¾—åˆ†
  â””â”€ è¿”å›ç»“æœ
  â†“
è¡¨ç¤ºå±‚: æ˜¾ç¤ºç»“æœ
  â””â”€ "è´µå·èŒ…å°: 70.0åˆ† (ä¸­ç­‰)"
```

**åœºæ™¯2ï¼šæ•°æ®ç¼ºå¤±ï¼Œè¯¢é—®é‡‡é›†**

```
ç”¨æˆ·: python stock_analyzer.py analyze 688888
  â†“
è¡¨ç¤ºå±‚: ensure_data_available(688888)
  â”œâ”€ æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
  â”œâ”€ æ•°æ®ç¼ºå¤± â†’ æ˜¾ç¤ºæŠ¥å‘Š
  â””â”€ è¯¢é—®ç”¨æˆ·: (y/n/i)?
  â†“
ç”¨æˆ·: y
  â†“
æ•°æ®å±‚: collector.collect_stock_data(688888)
  â”œâ”€ ä¸‹è½½PDF
  â”œâ”€ è§£ææ•°æ®
  â””â”€ å­˜å…¥æ•°æ®åº“
  â†“
è¡¨ç¤ºå±‚: "âœ“ æ•°æ®é‡‡é›†å®Œæˆ"
  â†“
ä¸šåŠ¡å±‚: framework.analyze(688888)
  â†“
è¡¨ç¤ºå±‚: æ˜¾ç¤ºç»“æœ
```

---

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. DataCollectorï¼ˆæ•°æ®é‡‡é›†æœåŠ¡ï¼‰

**ä½ç½®**: `src/services/data_collector.py`

**èŒè´£**ï¼š
- ç»Ÿä¸€çš„æ•°æ®é‡‡é›†æ¥å£
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- é™çº§ç­–ç•¥ç®¡ç†
- ç”¨æˆ·äº¤äº’å¤„ç†

**ä¾èµ–**ï¼š
```
DataCollector
â”œâ”€ Scraper (ä¸‹è½½)
â”œâ”€ Parser (è§£æ)
â”œâ”€ Database (å­˜å‚¨)
â””â”€ MockDataSource (é™çº§)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
collector = DataCollector()

# æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
report = collector.check_data_completeness("600519", years=5)

# é‡‡é›†æ•°æ®
success = collector.collect_stock_data(
    "600519",
    years=5,
    report_types=['annual'],
    incremental=False
)
```

### 2. FrameworkEngineï¼ˆåˆ†æå¼•æ“ï¼‰

**ä½ç½®**: `src/analysis/framework_engine.py`

**èŒè´£**ï¼š
- ç®¡ç†åˆ†ææ¡†æ¶
- åŠ è½½æ¡†æ¶é…ç½®
- æ‰§è¡Œåˆ†æé€»è¾‘

**ä¾èµ–**ï¼š
```
FrameworkEngine
â”œâ”€ ValueInvestingFramework
â”œâ”€ GrowthInvestingFramework
â””â”€ (æœªæ¥æ›´å¤šæ¡†æ¶)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
engine = FrameworkEngine()

# è·å–æ¡†æ¶
framework = engine.get_framework('value_investing')

# åˆ†æè‚¡ç¥¨
result = framework.analyze("600519")

# ç»“æœ
{
    'score': 70.0,
    'rating': 'ä¸­ç­‰',
    'dimensions': {
        'profitability': 85.0,
        'growth': 60.0,
        'financial_health': 75.0,
        'valuation': 65.0
    }
}
```

### 3. CLI Toolsï¼ˆå‘½ä»¤è¡Œå·¥å…·ï¼‰

**ä½ç½®**:
- `stock_analyzer.py`
- `collect_data.py`

**èŒè´£**ï¼š
- è§£æç”¨æˆ·è¾“å…¥
- è°ƒç”¨åº•å±‚æœåŠ¡
- å±•ç¤ºç»“æœ

**ç‰¹æ€§**ï¼š
- Clickæ¡†æ¶ï¼ˆä¼˜é›…çš„CLIï¼‰
- Richåº“ï¼ˆç¾è§‚çš„è¾“å‡ºï¼‰
- äº¤äº’å¼ç¡®è®¤
- è¿›åº¦æ¡æ˜¾ç¤º

---

## ğŸ”Œ æ‰©å±•æ€§è®¾è®¡

### 1. æ·»åŠ æ–°çš„æ•°æ®æº

**æ­¥éª¤**ï¼š

1. åˆ›å»ºæ–°çš„Scraperç±»ï¼š
```python
# src/scrapers/new_scraper.py
class NewScraper(BaseScraper):
    def scrape(self, stock_code, lookback_days):
        # å®ç°çˆ¬å–é€»è¾‘
        pass

    def download_report(self, announcement, stock_code):
        # å®ç°ä¸‹è½½é€»è¾‘
        pass
```

2. åœ¨DataCollectorä¸­æ·»åŠ å¸‚åœºæ£€æµ‹ï¼š
```python
def _detect_market(self, stock_code):
    if stock_code.startswith('NEW'):
        return 'NEW'
    # ...
```

3. åœ¨_fetch_and_save_reportä¸­æ·»åŠ åˆ†æ”¯ï¼š
```python
if market == 'NEW':
    scraper = NewScraper(market='NEW')
```

### 2. æ·»åŠ æ–°çš„åˆ†ææ¡†æ¶

**æ­¥éª¤**ï¼š

1. åˆ›å»ºæ¡†æ¶é…ç½®æ–‡ä»¶ï¼š
```yaml
# config/frameworks/momentum_investing.yaml
framework:
  name: åŠ¨é‡æŠ•èµ„æ¡†æ¶
  description: å…³æ³¨ä»·æ ¼è¶‹åŠ¿å’Œå¸‚åœºæƒ…ç»ª

  dimensions:
    - name: ä»·æ ¼åŠ¨é‡
      weight: 40%
      indicators:
        - price_change_1m: >5%
        - price_change_3m: >10%
```

2. åˆ›å»ºæ¡†æ¶ç±»ï¼š
```python
# src/analysis/momentum_investing.py
class MomentumInvestingFramework(BaseFramework):
    def analyze(self, stock_code):
        # å®ç°åˆ†æé€»è¾‘
        pass
```

3. åœ¨FrameworkEngineä¸­æ³¨å†Œï¼š
```python
'momentum_investing': MomentumInvestingFramework
```

### 3. æ·»åŠ æ–°çš„æ•°æ®å­—æ®µ

**æ­¥éª¤**ï¼š

1. æ›´æ–°æ•°æ®åº“æ¨¡å‹ï¼š
```python
# src/database/models.py
class FinancialMetric(Base):
    # æ–°å¢å­—æ®µ
    new_field = Column(Numeric(20, 4))
```

2. æ›´æ–°Parseræå–é€»è¾‘ï¼š
```python
# src/parsers/pdf_parser.py
parsed_data['new_field'] = extract_new_field(table)
```

3. æ›´æ–°DataCollectoræ˜ å°„ï¼š
```python
# src/services/data_collector.py
metric.new_field = to_decimal(data.get('new_field'))
```

4. åœ¨åˆ†ææ¡†æ¶ä¸­ä½¿ç”¨ï¼š
```yaml
indicators:
  - new_field: >100
```

### 4. æ·»åŠ Webç•Œé¢

**æœªæ¥è§„åˆ’**ï¼š

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ web_app.py              # Flask/FastAPIåº”ç”¨
â”œâ”€â”€ templates/              # HTMLæ¨¡æ¿
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ analyze.html
â”‚   â””â”€â”€ dashboard.html
â””â”€â”€ static/                 # é™æ€èµ„æº
    â”œâ”€â”€ css/
    â”œâ”€â”€ js/
    â””â”€â”€ img/
```

**æ¥å£è®¾è®¡**ï¼š

```python
# web_app.py
@app.route('/api/analyze', methods=['POST'])
def analyze_api():
    stock_code = request.json['stock_code']
    framework_name = request.json.get('framework', 'value_investing')

    # å¤ç”¨ç°æœ‰ç»„ä»¶
    engine = FrameworkEngine()
    framework = engine.get_framework(framework_name)
    result = framework.analyze(stock_code)

    return jsonify(result)
```

---

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### 1. æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•**ï¼š
```python
# å…³é”®å­—æ®µæ·»åŠ ç´¢å¼•
Index('idx_stock_code', Stock.stock_code)
Index('idx_report_stock_period', FinancialReport.stock_id,
      FinancialReport.fiscal_year, FinancialReport.fiscal_period)
```

**è¿æ¥æ± **ï¼š
```python
engine = create_engine(
    connection_string,
    pool_size=10,
    max_overflow=20,
    pool_recycle=3600
)
```

### 2. ç¼“å­˜ç­–ç•¥

**æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜**ï¼š
```python
@lru_cache(maxsize=100)
def get_latest_metrics(stock_code):
    # ç¼“å­˜æœ€è¿‘æŸ¥è¯¢çš„è‚¡ç¥¨æ•°æ®
    pass
```

**åˆ†æç»“æœç¼“å­˜**ï¼š
```python
# åŒä¸€å¤©å†…ç›¸åŒè‚¡ç¥¨çš„åˆ†æç»“æœç¼“å­˜
cache_key = f"{stock_code}_{date.today()}"
if cache_key in analysis_cache:
    return analysis_cache[cache_key]
```

### 3. å¹¶å‘å¤„ç†

**æ‰¹é‡é‡‡é›†ä¼˜åŒ–**ï¼ˆæœªæ¥ï¼‰ï¼š
```python
import concurrent.futures

def collect_multiple(stock_codes):
    with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
        futures = [
            executor.submit(collector.collect_stock_data, code)
            for code in stock_codes
        ]
        results = [f.result() for f in futures]
    return results
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æ•°æ®éªŒè¯

```python
def validate_stock_code(code: str) -> bool:
    """éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼"""
    if not code:
        return False

    # Aè‚¡
    if code.isdigit() and len(code) == 6:
        return True

    # æ¸¯è‚¡
    if code.isdigit() and len(code) == 5:
        return True

    # ç¾è‚¡
    if code.isalpha() and 1 <= len(code) <= 5:
        return True

    return False
```

### 2. SQLæ³¨å…¥é˜²æŠ¤

ä½¿ç”¨ORMï¼ˆSQLAlchemyï¼‰è‡ªåŠ¨é˜²æŠ¤ï¼š
```python
# å®‰å…¨ï¼šä½¿ç”¨ORM
stock = session.query(Stock).filter(Stock.stock_code == code).first()

# å±é™©ï¼šæ‹¼æ¥SQLï¼ˆæ°¸è¿œä¸è¦è¿™æ ·åšï¼‰
# query = f"SELECT * FROM stocks WHERE code = '{code}'"
```

### 3. æ–‡ä»¶è·¯å¾„å®‰å…¨

```python
def get_safe_file_path(stock_code: str, filename: str) -> Path:
    """å®‰å…¨çš„æ–‡ä»¶è·¯å¾„"""
    # æ¸…ç†å±é™©å­—ç¬¦
    safe_code = re.sub(r'[^a-zA-Z0-9]', '', stock_code)
    safe_filename = re.sub(r'[^a-zA-Z0-9._-]', '', filename)

    base_dir = Path('data/reports')
    path = base_dir / safe_code / safe_filename

    # ç¡®ä¿è·¯å¾„åœ¨base_dirå†…ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
    if not path.resolve().is_relative_to(base_dir.resolve()):
        raise ValueError("Invalid file path")

    return path
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

æ¯å±‚ç‹¬ç«‹æµ‹è¯•ï¼š

```python
# æµ‹è¯•æ•°æ®å±‚
def test_data_collector():
    collector = DataCollector()
    result = collector.collect_stock_data("MOCK_CODE", years=1)
    assert result == True

# æµ‹è¯•ä¸šåŠ¡é€»è¾‘å±‚
def test_value_investing_framework():
    framework = ValueInvestingFramework()
    result = framework.analyze("600519")
    assert 'score' in result
    assert 0 <= result['score'] <= 100

# æµ‹è¯•è¡¨ç¤ºå±‚
def test_cli_analyze_command():
    runner = CliRunner()
    result = runner.invoke(analyze, ['600519', '--skip-fetch'])
    assert result.exit_code == 0
```

### 2. é›†æˆæµ‹è¯•

è·¨å±‚æµ‹è¯•ï¼š

```python
def test_end_to_end_analysis():
    # 1. é‡‡é›†æ•°æ®
    collector = DataCollector()
    collector.collect_stock_data("600519", years=1)

    # 2. åˆ†æ
    engine = FrameworkEngine()
    framework = engine.get_framework('value_investing')
    result = framework.analyze("600519")

    # 3. éªŒè¯
    assert result['score'] > 0
    assert result['rating'] in ['ä¼˜ç§€', 'è‰¯å¥½', 'ä¸­ç­‰', 'ä¸åŠæ ¼']
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•

CLIå‘½ä»¤æµ‹è¯•ï¼š

```bash
# æµ‹è¯•å®Œæ•´æµç¨‹
python collect_data.py 600519 --years 1 --no-interactive
python stock_analyzer.py analyze 600519 --skip-fetch
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—å±‚çº§

```python
import logging

logger = logging.getLogger(__name__)

# DEBUG: è°ƒè¯•ä¿¡æ¯
logger.debug("å¼€å§‹è§£æPDF: %s", pdf_path)

# INFO: æ­£å¸¸æµç¨‹
logger.info("æˆåŠŸä¿å­˜ %s %så¹´%s", stock_code, year, report_type)

# WARNING: è­¦å‘Šä½†ä¸å½±å“åŠŸèƒ½
logger.warning("è§£æç½®ä¿¡åº¦è¾ƒä½: %.2f", confidence)

# ERROR: é”™è¯¯ä½†ç¨‹åºç»§ç»­
logger.error("ä¸‹è½½å¤±è´¥ï¼Œé™çº§åˆ°Mockæ•°æ®: %s", str(e))

# CRITICAL: ä¸¥é‡é”™è¯¯
logger.critical("æ•°æ®åº“è¿æ¥å¤±è´¥: %s", str(e))
```

### 2. æ€§èƒ½ç›‘æ§

```python
import time
from functools import wraps

def performance_monitor(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - start

        logger.info(
            "%s æ‰§è¡Œæ—¶é—´: %.2fç§’",
            func.__name__,
            elapsed
        )
        return result
    return wrapper

@performance_monitor
def collect_stock_data(stock_code):
    # ...
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™æ€»ç»“

### SOLIDåŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™ (SRP)**
   - DataCollectoråªè´Ÿè´£æ•°æ®é‡‡é›†
   - FrameworkEngineåªè´Ÿè´£åˆ†æé€»è¾‘
   - CLIå·¥å…·åªè´Ÿè´£ç”¨æˆ·äº¤äº’

2. **å¼€é—­åŸåˆ™ (OCP)**
   - å¯¹æ‰©å±•å¼€æ”¾ï¼šæ˜“äºæ·»åŠ æ–°æ¡†æ¶ã€æ–°æ•°æ®æº
   - å¯¹ä¿®æ”¹å°é—­ï¼šç°æœ‰ä»£ç ä¸éœ€è¦ä¿®æ”¹

3. **é‡Œæ°æ›¿æ¢åŸåˆ™ (LSP)**
   - æ‰€æœ‰Scraperå¯ä»¥äº’æ¢ä½¿ç”¨
   - æ‰€æœ‰Frameworkå¯ä»¥äº’æ¢ä½¿ç”¨

4. **æ¥å£éš”ç¦»åŸåˆ™ (ISP)**
   - BaseScraperå®šä¹‰æœ€å°æ¥å£
   - BaseFrameworkå®šä¹‰æœ€å°æ¥å£

5. **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**
   - é«˜å±‚æ¨¡å—ï¼ˆCLIï¼‰ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼ˆScraperï¼‰
   - éƒ½ä¾èµ–æŠ½è±¡ï¼ˆæ¥å£/åŸºç±»ï¼‰

### å…¶ä»–åŸåˆ™

- **DRY (Don't Repeat Yourself)**ï¼šä»£ç å¤ç”¨
- **KISS (Keep It Simple, Stupid)**ï¼šä¿æŒç®€å•
- **YAGNI (You Aren't Gonna Need It)**ï¼šä¸è¿‡åº¦è®¾è®¡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Phase1.3å®ç°æ€»ç»“.md](Phase1.3å®ç°æ€»ç»“.md) - æ•°æ®å±‚å®ç°
- [Phase2å®ç°æ€»ç»“.md](Phase2å®ç°æ€»ç»“.md) - ä¸šåŠ¡é€»è¾‘å±‚å’Œè¡¨ç¤ºå±‚
- [Phase3æµ‹è¯•æŠ¥å‘Š.md](Phase3æµ‹è¯•æŠ¥å‘Š.md) - ç«¯åˆ°ç«¯æµ‹è¯•
- [æ•°æ®é‡‡é›†æŒ‡å—.md](æ•°æ®é‡‡é›†æŒ‡å—.md) - æ•°æ®å±‚ä½¿ç”¨è¯´æ˜
- [CLI_USAGE.md](CLI_USAGE.md) - è¡¨ç¤ºå±‚ä½¿ç”¨è¯´æ˜

---

**æœ€åæ›´æ–°ï¼š** 2025-11-22
**é€‚ç”¨ç‰ˆæœ¬ï¼š** v3.0.0+
**æ¶æ„ç‰ˆæœ¬ï¼š** 1.0
