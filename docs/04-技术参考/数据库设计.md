# 数据库设计

> 文档版本：v1.0
> 创建日期：2024-11-21
> 数据库类型：SQLite (MVP) / PostgreSQL (生产)

## 概述

本系统使用关系型数据库存储股票信息、财报数据、分析结果等。MVP 阶段使用 SQLite，后期可迁移到 PostgreSQL。

## 技术选型

- **ORM**: SQLAlchemy 2.0+
- **迁移工具**: Alembic
- **数据库**: SQLite → PostgreSQL

---

## 数据表设计

### 1. stocks - 股票基本信息

存储股票的基本信息和元数据。

```sql
CREATE TABLE stocks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(20) NOT NULL UNIQUE,           -- 股票代码（如：600519, 00700, AAPL）
    name VARCHAR(100),                          -- 股票名称
    market VARCHAR(10) NOT NULL,                -- 市场类型：A, HK, US
    industry VARCHAR(50),                       -- 所属行业
    sector VARCHAR(50),                         -- 所属板块
    exchange VARCHAR(20),                       -- 交易所（如：SSE, SZSE, HKEX, NASDAQ）
    currency VARCHAR(10) DEFAULT 'CNY',         -- 货币单位
    listing_date DATE,                          -- 上市日期
    is_active BOOLEAN DEFAULT TRUE,             -- 是否活跃
    metadata JSON,                              -- 其他元数据（JSON格式）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stocks_code ON stocks(code);
CREATE INDEX idx_stocks_market ON stocks(market);
CREATE INDEX idx_stocks_industry ON stocks(industry);
```

**字段说明**：
- `code`: 股票代码，唯一标识
- `market`: A（A股）、HK（港股）、US（美股）
- `metadata`: 存储其他灵活的元数据，如公司简介、网址等

---

### 2. watchlist - 自选股列表

用户的自选股票列表。

```sql
CREATE TABLE watchlist (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_id INTEGER NOT NULL,                  -- 关联 stocks.id
    user_id INTEGER,                            -- 用户 ID（Phase 4 多用户时使用）
    tags VARCHAR(200),                          -- 标签（逗号分隔）
    notes TEXT,                                 -- 备注
    priority INTEGER DEFAULT 0,                 -- 优先级（0-10）
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE
);

CREATE INDEX idx_watchlist_stock ON watchlist(stock_id);
CREATE INDEX idx_watchlist_user ON watchlist(user_id);
```

**字段说明**：
- `tags`: 自定义标签，如 "高股息", "成长股"
- `priority`: 用于排序，数值越大优先级越高

---

### 3. financial_reports - 财报元数据

存储财报文件的元数据信息。

```sql
CREATE TABLE financial_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_id INTEGER NOT NULL,                  -- 关联 stocks.id
    report_type VARCHAR(20) NOT NULL,           -- 报告类型：annual, semi_annual, quarterly
    fiscal_year INTEGER NOT NULL,               -- 会计年度
    fiscal_period VARCHAR(10),                  -- 会计期间：Q1, Q2, Q3, Q4, H1, H2, FY
    report_date DATE NOT NULL,                  -- 报告期截止日期
    publish_date DATE,                          -- 发布日期
    file_path VARCHAR(500),                     -- 文件存储路径
    file_url VARCHAR(500),                      -- 原始文件 URL
    file_format VARCHAR(10),                    -- 文件格式：pdf, html, xml
    file_size INTEGER,                          -- 文件大小（字节）
    is_parsed BOOLEAN DEFAULT FALSE,            -- 是否已解析
    parsed_at TIMESTAMP,                        -- 解析时间
    checksum VARCHAR(64),                       -- 文件校验和（MD5/SHA256）
    metadata JSON,                              -- 其他元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE
);

CREATE INDEX idx_reports_stock ON financial_reports(stock_id);
CREATE INDEX idx_reports_date ON financial_reports(report_date);
CREATE INDEX idx_reports_type ON financial_reports(report_type);
CREATE UNIQUE INDEX idx_reports_unique ON financial_reports(stock_id, fiscal_year, fiscal_period);
```

**字段说明**：
- `report_type`: annual（年报）、semi_annual（半年报）、quarterly（季报）
- `fiscal_period`: Q1-Q4（季度）、H1-H2（半年）、FY（全年）
- `checksum`: 用于验证文件完整性，避免重复下载

---

### 4. financial_metrics - 财务指标

存储从财报中提取的结构化财务指标。

```sql
CREATE TABLE financial_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER NOT NULL,                 -- 关联 financial_reports.id
    stock_id INTEGER NOT NULL,                  -- 关联 stocks.id（冗余，便于查询）

    -- 基本信息
    report_date DATE NOT NULL,
    currency VARCHAR(10),

    -- 损益表指标
    revenue DECIMAL(20, 2),                     -- 营业收入
    revenue_yoy DECIMAL(10, 4),                 -- 营收同比增长率
    revenue_qoq DECIMAL(10, 4),                 -- 营收环比增长率
    operating_profit DECIMAL(20, 2),            -- 营业利润
    net_profit DECIMAL(20, 2),                  -- 净利润
    net_profit_yoy DECIMAL(10, 4),              -- 净利润同比增长率
    net_profit_qoq DECIMAL(10, 4),              -- 净利润环比增长率
    eps DECIMAL(10, 4),                         -- 每股收益
    gross_margin DECIMAL(10, 4),                -- 毛利率
    operating_margin DECIMAL(10, 4),            -- 营业利润率
    net_margin DECIMAL(10, 4),                  -- 净利率

    -- 资产负债表指标
    total_assets DECIMAL(20, 2),                -- 总资产
    total_liabilities DECIMAL(20, 2),           -- 总负债
    total_equity DECIMAL(20, 2),                -- 股东权益
    current_assets DECIMAL(20, 2),              -- 流动资产
    current_liabilities DECIMAL(20, 2),         -- 流动负债

    -- 财务比率
    asset_liability_ratio DECIMAL(10, 4),       -- 资产负债率
    current_ratio DECIMAL(10, 4),               -- 流动比率
    quick_ratio DECIMAL(10, 4),                 -- 速动比率
    roe DECIMAL(10, 4),                         -- 净资产收益率 ROE
    roa DECIMAL(10, 4),                         -- 总资产收益率 ROA

    -- 现金流量表指标
    operating_cash_flow DECIMAL(20, 2),         -- 经营性现金流
    investing_cash_flow DECIMAL(20, 2),         -- 投资性现金流
    financing_cash_flow DECIMAL(20, 2),         -- 筹资性现金流
    free_cash_flow DECIMAL(20, 2),              -- 自由现金流

    -- 估值指标（可选，可能从市场数据获取）
    pe_ratio DECIMAL(10, 4),                    -- 市盈率 PE
    pb_ratio DECIMAL(10, 4),                    -- 市净率 PB
    ps_ratio DECIMAL(10, 4),                    -- 市销率 PS

    -- 其他指标
    rd_expense DECIMAL(20, 2),                  -- 研发费用
    rd_ratio DECIMAL(10, 4),                    -- 研发费用率

    -- 元数据
    extraction_method VARCHAR(50),              -- 提取方法：auto, manual
    confidence_score DECIMAL(5, 4),             -- 置信度（0-1）
    notes TEXT,                                 -- 备注
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (report_id) REFERENCES financial_reports(id) ON DELETE CASCADE,
    FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE
);

CREATE INDEX idx_metrics_report ON financial_metrics(report_id);
CREATE INDEX idx_metrics_stock ON financial_metrics(stock_id);
CREATE INDEX idx_metrics_date ON financial_metrics(report_date);
CREATE UNIQUE INDEX idx_metrics_unique ON financial_metrics(stock_id, report_date);
```

**字段说明**：
- 所有比率字段使用 DECIMAL 类型存储，如 0.1523 表示 15.23%
- `_yoy`: Year-over-Year 同比
- `_qoq`: Quarter-over-Quarter 环比
- `confidence_score`: 自动提取的数据可能有误差，记录置信度

---

### 5. analysis_results - 分析结果

存储每次分析的结果。

```sql
CREATE TABLE analysis_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_id INTEGER NOT NULL,                  -- 关联 stocks.id
    report_id INTEGER,                          -- 关联 financial_reports.id（可选）
    framework_name VARCHAR(50) NOT NULL,        -- 分析框架名称
    framework_version VARCHAR(20),              -- 框架版本

    -- 评分
    overall_score DECIMAL(5, 2),                -- 综合评分（0-100）
    overall_rating VARCHAR(10),                 -- 综合评级：A+, A, B+, B, C, D

    -- 维度评分（JSON 格式，灵活存储不同框架的评分）
    dimension_scores JSON,                      -- 如：{"profitability": 95, "growth": 82, ...}

    -- 投资建议
    recommendation VARCHAR(20),                 -- 建议：BUY, HOLD, SELL
    recommendation_confidence DECIMAL(5, 4),    -- 建议置信度（0-1）
    reasoning TEXT,                             -- 推理过程

    -- 风险提示
    risks JSON,                                 -- 风险列表
    opportunities JSON,                         -- 机会列表

    -- AI 分析结果（可选）
    ai_summary TEXT,                            -- AI 生成的摘要
    ai_insights JSON,                           -- AI 提取的洞察

    -- 元数据
    analysis_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_time INTEGER,                     -- 执行时间（毫秒）

    FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE,
    FOREIGN KEY (report_id) REFERENCES financial_reports(id) ON DELETE SET NULL
);

CREATE INDEX idx_analysis_stock ON analysis_results(stock_id);
CREATE INDEX idx_analysis_date ON analysis_results(analysis_date);
CREATE INDEX idx_analysis_framework ON analysis_results(framework_name);
```

**字段说明**：
- `dimension_scores`: 不同框架有不同的评分维度，用 JSON 灵活存储
- `risks/opportunities`: JSON 数组，存储多个风险/机会点

---

### 6. frameworks - 分析框架配置

存储自定义的分析框架配置。

```sql
CREATE TABLE frameworks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,           -- 框架名称
    version VARCHAR(20) DEFAULT '1.0',          -- 版本
    type VARCHAR(20),                           -- 类型：value, growth, custom
    description TEXT,                           -- 描述
    config JSON NOT NULL,                       -- 框架配置（YAML 转 JSON）
    is_active BOOLEAN DEFAULT TRUE,             -- 是否启用
    is_builtin BOOLEAN DEFAULT FALSE,           -- 是否内置框架
    created_by VARCHAR(50),                     -- 创建者
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_frameworks_name ON frameworks(name);
CREATE INDEX idx_frameworks_type ON frameworks(type);
```

**字段说明**：
- `config`: 存储完整的框架配置，包括评分规则、权重等
- `is_builtin`: 内置框架（价值投资、成长投资）不可删除

---

### 7. market_expectations - 市场预期数据

存储市场分析师的预期数据（Phase 2 功能）。

```sql
CREATE TABLE market_expectations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_id INTEGER NOT NULL,                  -- 关联 stocks.id
    fiscal_year INTEGER NOT NULL,               -- 会计年度
    fiscal_period VARCHAR(10),                  -- 会计期间

    -- 预期指标
    expected_revenue DECIMAL(20, 2),            -- 预期营收
    expected_net_profit DECIMAL(20, 2),         -- 预期净利润
    expected_eps DECIMAL(10, 4),                -- 预期 EPS

    -- 预期范围
    revenue_low DECIMAL(20, 2),                 -- 营收下限
    revenue_high DECIMAL(20, 2),                -- 营收上限
    profit_low DECIMAL(20, 2),                  -- 利润下限
    profit_high DECIMAL(20, 2),                 -- 利润上限

    -- 数据来源
    source VARCHAR(50),                         -- 数据来源
    analyst_count INTEGER,                      -- 分析师数量
    consensus_rating VARCHAR(20),               -- 一致评级

    -- 元数据
    collected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE
);

CREATE INDEX idx_expectations_stock ON market_expectations(stock_id);
CREATE INDEX idx_expectations_period ON market_expectations(fiscal_year, fiscal_period);
```

---

## 数据库关系图

```
stocks (1) ──────< (N) financial_reports
  │                        │
  │                        │
  │                   (1) ─┴─ (N) financial_metrics
  │
  ├────< (N) watchlist
  ├────< (N) analysis_results
  └────< (N) market_expectations

frameworks (独立表)
```

---

## 索引策略

### 主要查询场景
1. 根据股票代码查询所有信息
2. 根据时间范围查询财报
3. 查询最新的分析结果
4. 查询自选股列表

### 索引设计原则
- 所有外键都建立索引
- 高频查询字段建立索引（stock_id, report_date, analysis_date）
- 唯一性约束（防止数据重复）

---

## 数据迁移计划

### SQLite → PostgreSQL

当需要迁移时：

1. **数据类型调整**：
   - SQLite 的 `DECIMAL` → PostgreSQL `NUMERIC`
   - SQLite 的 `JSON` → PostgreSQL `JSONB`（更高效）

2. **性能优化**：
   - 添加分区表（按年份分区财报数据）
   - 优化索引（B-tree, GIN, GiST）

3. **迁移工具**：
   - 使用 Alembic 管理 schema 变更
   - 使用脚本批量导出导入数据

---

## 初始化数据

### 内置分析框架

```sql
INSERT INTO frameworks (name, version, type, description, is_builtin, config) VALUES
('value_investing', '1.0', 'value', '价值投资框架（巴菲特风格）', TRUE, '...');

INSERT INTO frameworks (name, version, type, description, is_builtin, config) VALUES
('growth_investing', '1.0', 'growth', '成长投资框架（彼得·林奇）', TRUE, '...');
```

---

## 数据完整性

### 约束
1. **外键约束**：确保数据一致性
2. **唯一性约束**：防止重复数据
3. **非空约束**：关键字段不能为空

### 级联操作
- `ON DELETE CASCADE`: 删除股票时，关联的财报、指标、分析结果一并删除
- `ON DELETE SET NULL`: 删除财报时，分析结果的 report_id 设为 NULL

---

## 备份策略

### SQLite
```bash
# 简单备份
cp data/database.db data/backups/database_$(date +%Y%m%d).db

# 定期备份（cron）
0 2 * * * /path/to/backup.sh
```

### PostgreSQL
```bash
# 使用 pg_dump
pg_dump financial_db > backup.sql
```

---

## 性能优化建议

1. **查询优化**：
   - 使用 `EXPLAIN` 分析慢查询
   - 避免 `SELECT *`，只查询需要的字段
   - 使用分页查询大数据集

2. **索引优化**：
   - 定期 `ANALYZE` 更新统计信息
   - 删除未使用的索引

3. **连接池**：
   - 使用 SQLAlchemy 的连接池
   - 合理设置 pool_size 和 max_overflow

---

## 安全考虑

1. **SQL 注入防护**：使用 ORM 参数化查询
2. **敏感数据**：API keys 等不存数据库，用环境变量
3. **访问控制**：数据库用户最小权限原则

---

## 下一步

- [x] 完成数据库设计文档
- [ ] 实现 SQLAlchemy 模型（`src/database/models.py`）
- [ ] 实现数据库初始化脚本
- [ ] 编写数据库操作工具函数
