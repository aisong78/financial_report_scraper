# 产品架构设计

> 文档版本：v1.0
> 创建日期：2024-11-21
> 最后更新：2024-11-21

## 📋 目录

- [产品定位](#产品定位)
- [系统架构](#系统架构)
- [技术选型](#技术选型)
- [数据流设计](#数据流设计)
- [模块说明](#模块说明)

---

## 产品定位

### 目标用户
- **主要用户**：投资小白、散户投资者
- **使用场景**：个人投资决策辅助
- **未来规划**：发展为 SaaS 产品

### 核心价值主张
1. **简化财报阅读**：自动提取关键指标，降低理解门槛
2. **多框架分析**：提供价值投资、成长投资等多种分析视角
3. **AI 增强**：结合 LLM 深度理解财报文本
4. **准确可靠**：混合架构确保数据准确性，避免 AI 幻觉

### 投资策略
- 价值投资（寻找低估股票）
- 成长投资（寻找高增长公司）

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    财报智能分析系统                           │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  第一层：数据获取层 (Data Layer)                              │
├──────────────────────────────────────────────────────────────┤
│  ├── 财报爬虫模块                                             │
│  │   ├── A股/港股：巨潮资讯 (cninfo.com.cn)                  │
│  │   ├── 美股：SEC EDGAR                                     │
│  │   └── 定时调度器（财报季自动触发）                         │
│  ├── 财报解析模块                                             │
│  │   ├── PDF 文本提取 (pdfplumber)                           │
│  │   ├── 表格识别与结构化                                     │
│  │   └── 关键指标提取（正则 + 规则引擎）                      │
│  └── 数据存储                                                 │
│      ├── 原始财报文件 (PDF/HTML)                             │
│      ├── 结构化财务数据 (SQLite → PostgreSQL)                │
│      └── 分析历史记录                                         │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  第二层：分析引擎层 (Analysis Engine)                         │
├──────────────────────────────────────────────────────────────┤
│  ├── 指标计算模块                                             │
│  │   ├── 基础指标：营收、利润、ROE、PE 等                    │
│  │   ├── 增长指标：YoY、QoQ                                  │
│  │   ├── 质量指标：现金流、资产负债                          │
│  │   └── 预期对比（实际 vs 市场预期）                        │
│  ├── 分析框架引擎                                             │
│  │   ├── 预设框架库                                          │
│  │   │   ├── 价值投资框架（巴菲特风格）                      │
│  │   │   ├── 成长投资框架（彼得·林奇）                       │
│  │   │   ├── 财务健康度检查                                  │
│  │   │   └── 盈利质量分析                                    │
│  │   └── 自定义框架引擎                                       │
│  │       ├── 框架配置（YAML）                                │
│  │       └── 规则执行器                                       │
│  ├── AI 分析模块（混合模式）                                  │
│  │   ├── 结构化数据分析（传统算法，100% 准确）               │
│  │   ├── LLM 文本分析（管理层讨论、风险披露）                │
│  │   └── 结果校验层（防止 AI 胡编）                          │
│  └── 对比分析模块                                             │
│      ├── 同行业对比                                          │
│      ├── 历史趋势对比                                        │
│      └── 市场预期对比                                        │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  第三层：决策建议层 (Decision Layer)                          │
├──────────────────────────────────────────────────────────────┤
│  ├── 评分系统                                                 │
│  │   ├── 多维度打分                                          │
│  │   ├── 框架权重配置                                        │
│  │   └── 综合评级                                            │
│  ├── 投资建议生成                                             │
│  │   ├── 买入/持有/卖出信号                                  │
│  │   ├── 风险提示                                            │
│  │   └── 关注点总结                                          │
│  └── 报告生成器                                               │
│      ├── Markdown 报告                                       │
│      ├── PDF 导出                                            │
│      └── 邮件通知                                            │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  第四层：用户交互层 (Interface Layer)                         │
├──────────────────────────────────────────────────────────────┤
│  ├── CLI 工具（Phase 1）                                      │
│  │   ├── 查询单只股票                                        │
│  │   ├── 分析自选股                                          │
│  │   └── 手动触发分析                                        │
│  └── Web 界面（Phase 4）                                      │
│      ├── 仪表盘                                               │
│      ├── 自选股管理                                          │
│      └── 报告查看                                            │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  第五层：调度监控层 (Scheduler & Monitor)                     │
├──────────────────────────────────────────────────────────────┤
│  ├── 财报季日历                                               │
│  │   ├── 财报发布前（预期收集）                              │
│  │   ├── 财报发布时（自动下载分析）                          │
│  │   └── 财报发布后（持续跟踪）                              │
│  └── 自动化任务                                               │
│      ├── 定时爬取                                            │
│      ├── 定时分析                                            │
│      └── 告警通知                                            │
└──────────────────────────────────────────────────────────────┘
```

---

## 技术选型

### 开发语言
- **Python 3.9+**：主要开发语言

### 核心依赖

#### 数据获取
- `requests`：HTTP 请求
- `sec-edgar-downloader`：美股 SEC 文件下载
- `pdfplumber`：PDF 解析
- `beautifulsoup4`：HTML 解析

#### 数据处理
- `pandas`：数据分析
- `numpy`：数值计算

#### 数据存储
- **Phase 1**: `SQLite`（轻量级，零配置）
- **Phase 4**: `PostgreSQL`（生产环境）
- `SQLAlchemy`：ORM

#### AI 集成
- `anthropic`：Claude API
- `openai`：OpenAI API（备选）

#### 任务调度
- `APScheduler`：定时任务

#### 报告生成
- `jinja2`：模板引擎
- `markdown2`：Markdown 处理
- `reportlab` / `weasyprint`：PDF 生成

#### 日志和监控
- `logging`：标准日志库
- `loguru`：增强日志（可选）

#### 配置管理
- `pyyaml`：YAML 配置文件
- `python-dotenv`：环境变量

#### 测试
- `pytest`：单元测试
- `pytest-cov`：测试覆盖率

### 前端技术（Phase 4）
- **框架**：React / Vue.js
- **UI 库**：Ant Design / Element UI
- **图表**：ECharts / Chart.js

---

## 数据流设计

### 主流程

```
用户触发
    ↓
[1] 获取财报
    ├─ 检查本地缓存
    ├─ 调用爬虫下载
    └─ 存储原始文件
    ↓
[2] 解析财报
    ├─ PDF/HTML 文本提取
    ├─ 表格识别
    └─ 关键指标提取
    ↓
[3] 数据入库
    ├─ 结构化数据存储
    └─ 元数据记录
    ↓
[4] 分析计算
    ├─ 指标计算
    ├─ 框架分析
    ├─ AI 文本分析
    └─ 对比分析
    ↓
[5] 生成报告
    ├─ 评分
    ├─ 投资建议
    └─ Markdown/PDF 输出
    ↓
[6] 通知用户
    ├─ CLI 输出
    └─ 邮件发送（可选）
```

### 数据存储结构

```
data/
├── reports/              # 原始财报文件
│   ├── A_stocks/
│   ├── HK_stocks/
│   └── US_stocks/
├── database.db           # SQLite 数据库
├── cache/                # 临时缓存
└── exports/              # 导出报告
    ├── markdown/
    └── pdf/
```

---

## 模块说明

### 1. 数据获取层

#### scrapers/ - 爬虫模块
- `a_stock_scraper.py`：A股巨潮资讯爬虫
- `hk_stock_scraper.py`：港股巨潮资讯爬虫
- `us_stock_scraper.py`：美股 SEC EDGAR 爬虫
- `scheduler.py`：定时任务调度

**关键功能**：
- 股票代码识别
- 财报自动下载
- 去重检查
- 错误重试

#### parsers/ - 解析模块
- `pdf_parser.py`：PDF 财报解析
- `html_parser.py`：HTML 财报解析
- `metric_extractor.py`：指标提取器

**关键功能**：
- 文本提取
- 表格识别
- 数据清洗
- 指标计算

### 2. 分析引擎层

#### analyzers/ - 分析模块
- `framework_engine.py`：分析框架引擎
- `ai_analyzer.py`：AI 分析模块
- `comparator.py`：对比分析
- `frameworks/`：预设分析框架
  - `value.py`：价值投资框架
  - `growth.py`：成长投资框架

**价值投资框架关键指标**：
- ROE（净资产收益率）> 15%
- 负债率 < 50%
- 自由现金流 > 0
- PE 低于行业平均
- 连续盈利记录

**成长投资框架关键指标**：
- 营收增长率 > 20%
- 净利润增长率 > 20%
- 毛利率稳定或上升
- 研发投入占比
- 市场份额增长

### 3. 数据层

#### database/ - 数据库模块
- `models.py`：数据模型定义
- `db.py`：数据库连接和操作
- `migrations/`：数据库迁移

**核心数据表**：
- `stocks`：股票基本信息
- `watchlist`：自选股列表
- `financial_reports`：财报元数据
- `financial_metrics`：财务指标
- `analysis_results`：分析结果
- `frameworks`：分析框架配置
- `market_expectations`：市场预期数据

### 4. 报告生成

#### reporters/ - 报告模块
- `markdown_reporter.py`：Markdown 报告生成
- `pdf_reporter.py`：PDF 报告生成
- `templates/`：报告模板

### 5. 用户交互

#### cli/ - 命令行工具
- `main.py`：CLI 主程序

**命令示例**：
```bash
# 分析单只股票
python -m src.cli.main analyze --stock 600519

# 分析自选股
python -m src.cli.main analyze --watchlist

# 添加自选股
python -m src.cli.main watchlist add 600519 00700 AAPL

# 使用指定框架
python -m src.cli.main analyze --stock 600519 --framework value
```

---

## 安全和质量保证

### 数据准确性
1. **结构化数据**：使用确定性算法提取，确保 100% 准确
2. **AI 分析**：仅用于文本理解，不涉及关键数值
3. **校验机制**：多重验证确保数据一致性

### 安全措施
1. **敏感信息**：使用环境变量，不提交到 Git
2. **HTTPS**：所有网络请求使用加密连接
3. **输入验证**：防止注入攻击
4. **访问控制**：多用户模式下的权限管理

### 代码质量
1. **类型提示**：全部代码使用类型注解
2. **单元测试**：核心模块测试覆盖率 > 80%
3. **代码规范**：遵循 PEP 8
4. **文档完整**：每个模块都有详细 docstring

---

## 性能考虑

### 并发处理
- 使用线程池并发下载财报
- 批量数据库操作
- 缓存机制减少重复计算

### 可扩展性
- 模块化设计，易于添加新功能
- 插件式分析框架
- 数据库可平滑迁移到 PostgreSQL

---

## 下一步

详见 [分阶段实施计划](./分阶段实施计划.md)
