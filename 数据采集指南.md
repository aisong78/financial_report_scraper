# 数据采集指南

> 📖 本指南详细说明如何使用 `collect_data.py` 工具采集和管理财务数据

---

## 📋 目录

1. [快速开始](#快速开始)
2. [基本用法](#基本用法)
3. [高级功能](#高级功能)
4. [数据完整性检查](#数据完整性检查)
5. [常见场景](#常见场景)
6. [故障排查](#故障排查)

---

## 🚀 快速开始

### 最简单的使用方式

```bash
# 采集单只股票的5年年报数据
python collect_data.py 600519
```

这会自动：
- 检查数据完整性
- 询问你是否采集
- 下载PDF财报
- 解析并存入数据库
- 显示采集进度

---

## 📖 基本用法

### 1. 采集单只股票

```bash
# 采集贵州茅台（600519）的数据
python collect_data.py 600519
```

**输出示例**：
```
数据完整性检查: 600519

数据库状态: ✓ 存在
期望报告数: 5
实际报告数: 3
完整度: 60.0%

缺失年份: 2023, 2024
缺失报告: 年报

是否开始数据采集？
将采集 600519 的全部数据

选项：
  y - 开始采集
  n - 跳过
  i - 增量更新（仅更新最新数据）

请选择 (y/n/i): y

开始采集数据: 600519
正在采集 2024年 年报 ━━━━━━━━━━━━━━━━━━━━ 100%
✓ 成功保存 600519 2024年annual

采集完成！
总计: 2 份报告
成功: 2 份
失败: 0 份
```

### 2. 批量采集多只股票

```bash
# 采集多只股票
python collect_data.py 600519 688005 000858
```

### 3. 指定年份范围

```bash
# 仅采集最近3年数据
python collect_data.py 600519 --years 3

# 仅采集最近1年数据
python collect_data.py 600519 --years 1
```

### 4. 指定报告类型

```bash
# 仅采集年报
python collect_data.py 600519 --reports annual

# 采集年报和半年报
python collect_data.py 600519 --reports annual,semi

# 采集所有类型（年报、半年报、季报）
python collect_data.py 600519 --reports annual,semi,quarter
```

**报告类型说明**：
- `annual`: 年报（推荐，数据最全）
- `semi`: 半年报/中期报告
- `quarter`: 季度报告

---

## 🔧 高级功能

### 1. 增量更新

仅更新最新数据，适用于数据已存在但可能过期的情况：

```bash
python collect_data.py 600519 --incremental
# 或使用简写
python collect_data.py 600519 -i
```

**与完整采集的区别**：

| 模式 | 采集范围 | 适用场景 |
|------|---------|---------|
| 完整采集 | 所有缺失年份 | 首次采集、数据大量缺失 |
| 增量更新 | 仅最新1年 | 日常更新、数据基本完整 |

### 2. 跳过用户交互

适用于自动化脚本，不需要人工确认：

```bash
python collect_data.py 600519 --no-interactive
```

**效果**：
- 跳过所有确认提示
- 自动采集所有缺失数据
- 适合定时任务

### 3. 仅检查数据完整性

查看数据状态，不执行采集：

```bash
python collect_data.py 600519 --check-only
```

**输出示例**：
```
数据完整性检查: 600519

╔═══════════════════════════════════════╗
║    数据完整性报告: 600519               ║
╚═══════════════════════════════════════╝

  数据库状态: ✓ 存在
  股票名称: 贵州茅台

  期望报告数: 5 份（年报）
  实际报告数: 5 份
  完整度: 100.0%

  ✓ 数据完整，无需采集
```

### 4. 组合参数使用

```bash
# 增量更新3年年报，跳过交互
python collect_data.py 600519 --years 3 --reports annual --incremental --no-interactive

# 检查多只股票的数据完整性
python collect_data.py 600519 688005 000858 --check-only
```

---

## 🔍 数据完整性检查

### 完整性报告解读

```
数据完整性报告: 600519

  数据库状态: ✓ 存在
  股票名称: 贵州茅台

  期望报告数: 5 份（年报）
  实际报告数: 3 份
  完整度: 60.0%

  缺失年份: 2023, 2024
  缺失报告: 年报
```

**字段说明**：

| 字段 | 说明 |
|------|------|
| 数据库状态 | ✓ 存在 / ✗ 不存在 |
| 期望报告数 | 根据 --years 和 --reports 计算 |
| 实际报告数 | 数据库中已有的报告数量 |
| 完整度 | 实际报告数 / 期望报告数 × 100% |
| 缺失年份 | 哪些年份的数据缺失 |
| 缺失报告 | 缺失的报告类型 |

### 完整度阈值

- **100%**：数据完整，无需采集
- **60-99%**：部分缺失，建议补充采集
- **0-59%**：大量缺失，建议完整采集
- **0%**：无数据，首次采集

---

## 💡 常见场景

### 场景1：首次使用，采集新股票

```bash
# 1. 先检查数据状态
python collect_data.py 600519 --check-only

# 2. 确认需要采集后，开始采集
python collect_data.py 600519

# 3. 选择 y（完整采集）
```

**预期结果**：
- 完整度: 0% → 100%
- 采集时间: 约2-5分钟（5年数据）

### 场景2：日常更新数据

```bash
# 使用增量更新模式
python collect_data.py 600519 --incremental
```

**预期结果**：
- 仅采集最新1年数据
- 采集时间: 约30秒-1分钟

### 场景3：补充缺失数据

```bash
# 1. 检查发现缺失2023、2024年数据
python collect_data.py 600519 --check-only

# 2. 完整采集补充缺失数据
python collect_data.py 600519

# 3. 选择 y
```

### 场景4：批量初始化股票池

```bash
# 准备股票列表
STOCKS="600519 688005 000858 601318 601888"

# 批量采集（跳过交互）
python collect_data.py $STOCKS --no-interactive

# 或逐个采集（有交互确认）
python collect_data.py 600519 688005 000858
```

### 场景5：定时任务自动更新

```bash
#!/bin/bash
# daily_update.sh - 每日自动更新脚本

# 读取自选股列表
STOCKS=$(cat my_stocks.txt)

# 增量更新所有股票（跳过交互）
python collect_data.py $STOCKS --incremental --no-interactive

echo "数据更新完成: $(date)"
```

**设置定时任务**（Linux/Mac）：
```bash
# 每天早上6点自动更新
crontab -e

# 添加：
0 6 * * * /path/to/daily_update.sh
```

### 场景6：采集不同报告类型

```bash
# 仅采集年报（推荐，数据最全）
python collect_data.py 600519 --reports annual

# 采集年报+半年报（更及时）
python collect_data.py 600519 --reports annual,semi

# 采集所有报告（数据量大）
python collect_data.py 600519 --reports annual,semi,quarter
```

---

## 🎯 参数速查表

| 参数 | 简写 | 说明 | 示例 |
|------|------|------|------|
| `stock_codes` | - | 股票代码（必需） | `600519` |
| `--years` | `-y` | 采集年份数（默认5） | `--years 3` |
| `--reports` | `-r` | 报告类型（默认年报） | `--reports annual,semi` |
| `--incremental` | `-i` | 增量更新模式 | `--incremental` |
| `--no-interactive` | - | 跳过用户确认 | `--no-interactive` |
| `--check-only` | - | 仅检查不采集 | `--check-only` |

---

## ⚙️ 配置说明

### 数据存储位置

- **数据库**: `data/database.db`
- **下载的PDF**: `data/reports/{stock_code}/`

### 市场类型自动识别

工具会自动识别股票市场：

| 代码格式 | 市场 | 示例 |
|---------|------|------|
| 6位数字（0/3/6开头） | A股 | 600519, 000858, 300750 |
| 5位数字（0开头） | 港股 | 00700 |
| 字母 | 美股 | AAPL, TSLA |

**注意**：美股需要配置邮箱（SEC要求）

```bash
cp config.json.example config.json
# 编辑 config.json，设置你的邮箱
```

---

## 🐛 故障排查

### 问题1：提示"无法获取股票信息"

**可能原因**：
1. 股票代码错误或不存在
2. 网络连接问题
3. 数据源暂时不可用

**解决方法**：
```bash
# 1. 检查股票代码是否正确
python stock_analyzer.py info 600519

# 2. 检查网络连接
ping www.cninfo.com.cn

# 3. 稍后重试
```

### 问题2：采集失败，降级到Mock数据

**输出示例**：
```
⚠ 未找到 688005 的财报，使用Mock数据
✓ 成功保存 688005 2024年annual (Mock)
```

**说明**：
- 系统自动降级到Mock数据（模拟数据）
- Mock数据可用于测试，但不应用于实际投资决策
- 可以稍后重试采集真实数据

**解决方法**：
```bash
# 重新采集（会覆盖Mock数据）
python collect_data.py 688005
```

### 问题3：解析置信度低

**输出示例**：
```
解析完成，置信度: 25%
⚠ 置信度过低，使用Mock数据
```

**说明**：
- PDF解析成功，但提取的数据不完整
- 置信度 < 30% 时自动降级
- 可能原因：PDF格式特殊、表格结构异常

**解决方法**：
1. 检查PDF文件是否完整：`data/reports/{stock_code}/`
2. 稍后重试（可能是临时问题）
3. 提Issue反馈PDF格式问题

### 问题4：依赖缺失

**输出示例**：
```
Scrapers不可用，将使用Mock数据: No module named 'dotenv'
```

**说明**：
- 缺少可选依赖（pdfplumber、python-dotenv等）
- 系统自动降级到Mock数据
- 不影响基本功能

**解决方法**：
```bash
# 安装完整依赖
pip install pdfplumber python-dotenv requests

# 重新尝试采集
python collect_data.py 600519
```

### 问题5：数据库锁定

**错误示例**：
```
database is locked
```

**原因**：
- 多个程序同时访问数据库
- 上次操作异常中断

**解决方法**：
```bash
# 1. 关闭其他正在运行的程序
pkill -f collect_data.py
pkill -f stock_analyzer.py

# 2. 等待几秒后重试
sleep 5
python collect_data.py 600519

# 3. 如果仍然失败，删除锁文件
rm data/database.db-journal
```

---

## 📊 采集性能

### 单只股票采集时间

| 数据量 | 预计时间 | 说明 |
|-------|---------|------|
| 1年年报 | 30秒-1分钟 | 增量更新 |
| 3年年报 | 1-3分钟 | 常规采集 |
| 5年年报 | 2-5分钟 | 完整采集 |
| 5年所有报告 | 10-15分钟 | 包括半年报、季报 |

**影响因素**：
- 网络速度
- PDF文件大小
- 服务器响应时间

### 批量采集优化建议

**不推荐**：一次采集过多股票
```bash
# 可能超时或失败
python collect_data.py 600519 688005 ... (20+只股票)
```

**推荐**：分批采集
```bash
# 每批5-10只股票
python collect_data.py 600519 688005 000858 601318 601888
python collect_data.py 600036 600030 600887 600276 600809
```

---

## 💡 最佳实践

### 1. 首次使用

```bash
# Step 1: 检查数据状态
python collect_data.py 600519 --check-only

# Step 2: 采集完整数据（5年年报）
python collect_data.py 600519

# Step 3: 验证数据
python stock_analyzer.py info 600519
```

### 2. 日常维护

```bash
# 每周或每月增量更新
python collect_data.py 600519 --incremental

# 或使用完整采集（自动跳过已有数据）
python collect_data.py 600519
```

### 3. 批量管理

创建股票列表文件 `my_stocks.txt`：
```
600519
688005
000858
601318
```

批量采集脚本：
```bash
#!/bin/bash
while read stock; do
    echo "采集 $stock..."
    python collect_data.py $stock --incremental --no-interactive
    sleep 2  # 避免请求过快
done < my_stocks.txt
```

### 4. 数据质量检查

```bash
# 1. 检查所有股票的数据完整性
python collect_data.py 600519 688005 000858 --check-only

# 2. 查看数据库统计
python stock_analyzer.py list

# 3. 验证关键股票的数据
python stock_analyzer.py info 600519
```

---

## 🆘 获取帮助

```bash
# 查看完整帮助信息
python collect_data.py --help

# 查看版本信息
python collect_data.py --version
```

**更多文档**：
- [快速开始指南.md](快速开始指南.md) - 系统使用教程
- [CLI_USAGE.md](CLI_USAGE.md) - 命令行工具手册
- [Phase1.3实现总结.md](Phase1.3实现总结.md) - 技术实现说明

**遇到问题？**
- 查看 [故障排查](#故障排查) 部分
- 提交 Issue: https://github.com/aisong78/financial_report_scraper/issues

---

**最后更新：** 2025-11-22
**适用版本：** v3.0.0+
